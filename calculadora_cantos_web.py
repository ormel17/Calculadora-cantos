import streamlit as st
import math
import pandas as pd

st.set_page_config(page_title="Calculadora de Canto LAMIRED", layout="centered")
st.title("üßÆ Calculadora de Longitud de Canto - LAMIRED")

st.write("Ingresa los valores para calcular la longitud aproximada del canto (usando el diametro de la circunferencia).")

# Inputs organizados
col1, col2, col3 = st.columns(3)
with col1:
    d_ext = st.number_input("Di√°metro externo (cm):", min_value=0.0, format="%.2f")
with col2:
    d_int = st.number_input("Di√°metro interno (cm):", min_value=0.0, format="%.2f")
with col3:
    espesor = st.number_input("Espesor (mm):", min_value=0.0, format="%.2f")

# Inicializar historial
if "historial" not in st.session_state:
    st.session_state.historial = []

# ---- Opciones de salida (sidebar): redondeo operativo ----
with st.sidebar:
    st.header("‚öôÔ∏è Opciones de salida")
    redondeo = st.selectbox(
        "Redondear longitud a",
        ["Sin redondeo", "0.1 m", "0.5 m", "1 m"],
        index=0
    )
    modo_redondeo = st.selectbox(
        "Modo de redondeo",
        ["Normal (‚âà)", "Hacia abajo (floor)", "Hacia arriba (ceil)"],
        index=0
    )

# Helper para redondeo
import math as _math
def _round_to_step(valor: float, paso: float, modo: str) -> float:
    if paso <= 0:
        return valor
    q = valor / paso
    if modo == "Hacia abajo (floor)":
        return _math.floor(q) * paso
    elif modo == "Hacia arriba (ceil)":
        return _math.ceil(q) * paso
    else:  # Normal (‚âà)
        return round(q) * paso



# Bot√≥n de c√°lculo
if st.button("Calcular longitud"):
    # Validaciones
    if d_ext <= 0 or d_int < 0 or espesor <= 0:
        st.error("Todos los valores deben ser > 0 (y el di√°metro interno puede ser 0).")
    elif d_ext <= d_int:
        st.error("El di√°metro externo debe ser mayor que el di√°metro interno.")
    else:
        # √Årea del anillo en cm¬≤
        area_cm2 = math.pi * (((d_ext / 2.0) ** 2) - ((d_int / 2.0) ** 2))
        # Resultado en METROS: cm¬≤ / (mm*0.1) = cm, luego /100 = m  ‚áí dividir entre (espesor*10)
        longitud_m = area_cm2 / (espesor * 10.0)

        st.success(f"üëâ La longitud aproximada del canto es: **{longitud_m:.2f} metros**")

        # Guardar en historial
        st.session_state.historial.append({
            "Di√°metro externo (cm)": round(d_ext, 2),
            "Di√°metro interno (cm)": round(d_int, 2),
            "Espesor (mm)": round(espesor, 2),
            "Longitud (m)": round(longitud_m, 2)
        })

# Mostrar historial
if st.session_state.historial:
    st.subheader("üìä Historial de c√°lculos")
    df = pd.DataFrame(st.session_state.historial)
    st.table(df)
    st.download_button(
        "üì• Descargar historial en CSV",
        df.to_csv(index=False),
        "historial_cantos.csv",
        "text/csv"
    )
